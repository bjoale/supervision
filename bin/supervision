#!/usr/bin/env bash

SUPERVISION_VERSION="0.1.1"

use() {
  versions | grep ^"$1"$ > /dev/null
  if [ $? -eq 0 ]; then
    ln -sfh ${SUPERVISION_VERSIONS_ROOT}/$1 ${SITEVISION_ROOT}
    echo "Now using SiteVision $1."
  else
    echo "SiteVision $1 is not installed."
    exit 1
  fi
}

version() {
  check_for_symlink
  basename `readlink ${SITEVISION_ROOT}`
}

versions() {
  ls "$SUPERVISION_VERSIONS_ROOT" | sort
}

console() {
  check_for_symlink
  pushd ${SITEVISION_ROOT}/bin > /dev/null
  sudo ./sitevision console
  popd > /dev/null
}

supervision_version() {
  echo "supervision ${SUPERVISION_VERSION}"
}

usage() {
  supervision_version
  echo "usage: supervision <command> [<args>]"
  echo ""
  echo "What supervision can do for you:"
  echo "   use           Set the SiteVision version"
  echo "   version       Show the current SiteVision version"
  echo "   versions      List all SiteVision versions known to supervision"
  echo "   console       Start the current SiteVision version in console mode"
}

bootstrap() {
  mkdir -p ${SUPERVISION_VERSIONS_ROOT}
}

check_for_symlink() {
  if ! [ -L ${SITEVISION_ROOT} -a -d ${SITEVISION_ROOT} ]; then
    echo "No SiteVision version is set."
    exit 1
  fi
}

SUPERVISION_ROOT="${HOME}/.supervision"
SUPERVISION_VERSIONS_ROOT="${SUPERVISION_ROOT}/versions"
SITEVISION_ROOT="/opt/sitevision"

bootstrap

case "$1" in
  "use" )
    use $2
    ;;
  "versions" )
    versions
    ;;
  "version" )
    version
    ;;
  "console" )
    console
    ;;
  "--version" )
    supervision_version
    ;;
  *)
    usage
    exit 1
    ;;
esac

exit 0
